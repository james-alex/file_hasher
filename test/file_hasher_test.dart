import 'dart:io';
import 'dart:typed_data';
import 'package:file_hasher/file_hasher.dart';
import 'package:test/test.dart';

void main() {
  test('hash', () async {
    await testHasher(((file, chunkSize, seed, secret, key) async {
      final hash = await FileHasher.hash(
        file,
        chunkSize: chunkSize,
        seed: seed,
        secret: secret,
      );
      expect(hash, equals(fileValues[secret]![seed]![chunkSize]![key]));
    }));
  });

  test('hashSync', () async {
    await testHasher(((file, chunkSize, seed, secret, key) async {
      final hash = FileHasher.hashSync(
        file,
        chunkSize: chunkSize,
        seed: seed,
        secret: secret,
      );
      expect(hash, equals(fileValues[secret]![seed]![chunkSize]![key]));
    }));
  });

  test('smash', () async {
    await testSmasher(((files, chunkSize, seed, secret, keys) async {
      final hash = await FileHasher.smash(
        files,
        chunkSize: chunkSize,
        seed: seed,
        secret: secret,
      );
      expect(hash, equals(multiFileValues[keys]![secret]![seed]![chunkSize]));
    }));
  });

  test('smashSync', () async {
    await testSmasher(((files, chunkSize, seed, secret, keys) async {
      final hash = FileHasher.smashSync(
        files,
        chunkSize: chunkSize,
        seed: seed,
        secret: secret,
      );
      expect(hash, equals(multiFileValues[keys]![secret]![seed]![chunkSize]));
    }));
  });
}

/// Validates each of the hashes in [fileValues] with the provided [tester].
Future<void> testHasher(
    Future<void> Function(
            File file, int chunkSize, int seed, Uint8List? secret, int key)
        tester) async {
  for (var secret in fileValues.keys) {
    for (var seed in fileValues[secret]!.keys) {
      for (var chunkSize in fileValues[secret]![seed]!.keys) {
        for (var key in fileValues[secret]![seed]![chunkSize]!.keys) {
          final file =
              File.fromUri(Uri.file('./test/test_files/${key}_strings.txt'));
          await tester(file, chunkSize, seed, secret, key);
        }
      }
    }
  }
}

/// Validates each of the hashes in [multiFileValues] with the provided [tester].
Future<void> testSmasher(
    Future<void> Function(List<File> files, int chunkSize, int seed,
            Uint8List? secret, List<int> keys)
        tester) async {
  for (var keys in multiFileValues.keys) {
    for (var secret in multiFileValues[keys]!.keys) {
      for (var seed in multiFileValues[keys]![secret]!.keys) {
        for (var chunkSize in multiFileValues[keys]![secret]![seed]!.keys) {
          final files = keys
              .map<File>((key) => File.fromUri(
                  Uri.file('./test/test_files/${key}_strings.txt')))
              .toList(growable: false);
          await tester(files, chunkSize, seed, secret, keys);
        }
      }
    }
  }
}

/// The expected hashes for the test files with a hierarchy
/// of secret > seed > chunk-size > key > hash.
final fileValues = <Uint8List?, Map<int, Map<int, Map<int, int>>>>{
  null: {
    0: {
      500: {
        100: -3032997278740750984,
        333: 2209479159823221268,
        500: -4057324985269895126,
        667: 4368754354838703396,
        1000: -76148115975564611,
        3333: -3859331066945667302,
        5000: 1509858732865030094,
      },
      1000: {
        100: -3666692470376016684,
        333: 4613292103376563028,
        500: 4706129416755185608,
        667: -8084685997639499146,
        1000: -7072826855189515592,
        3333: -4974412740935026619,
        5000: 8953506417723693620,
      },
      2500: {
        100: -7736480419412625512,
        333: -4173717624648823985,
        500: 3818403753906368921,
        667: -610286071347829006,
        1000: 1749130001683896124,
        3333: 3504570093432320784,
        5000: 5019913416260871378,
      },
      5000: {
        100: -7736480419412625512,
        333: -6237370886884326770,
        500: -3141932166116815194,
        667: 2313554198846568625,
        1000: 7516022349342673842,
        3333: -826194923059483612,
        5000: -6338810681959681451,
      },
    },
    333: {
      500: {
        100: 3823992694937131329,
        333: -1578910464046787409,
        500: -5137934530009312488,
        667: -8489708239031148066,
        1000: 7891850967756833365,
        3333: -2101538655790721857,
        5000: 2707994790432781727,
      },
      1000: {
        100: 5506876079060018019,
        333: -2624031355507386024,
        500: 8630513502922378960,
        667: 6433045179479453050,
        1000: -2665417937332403869,
        3333: 2677350434829287065,
        5000: -3829737870659960403,
      },
      2500: {
        100: 1420298020894457879,
        333: -5726210660602267016,
        500: 2639444558984084054,
        667: 6988071148650626833,
        1000: -3636563690043646574,
        3333: -5017229923851828957,
        5000: 7914703336206827407,
      },
      5000: {
        100: 1420298020894457879,
        333: -5158704605988946236,
        500: -7349679691409685735,
        667: 8304486666046637279,
        1000: 2102612870227062828,
        3333: 3240907656467481981,
        5000: 6384787114285998307,
      },
    },
    667: {
      500: {
        100: -6102754757154775298,
        333: -3814194827232115433,
        500: -2318047326445149030,
        667: 1837081734896643255,
        1000: -5568017472730569429,
        3333: 7725606641675678917,
        5000: 607968695284935600,
      },
      1000: {
        100: -4662280829096286418,
        333: 3641567946301184827,
        500: -6919696288182135437,
        667: 1661744377623986684,
        1000: 7076042916519103995,
        3333: 5298949586565512748,
        5000: 9205416599543595598,
      },
      2500: {
        100: -5469093104035258467,
        333: 7493770317985815771,
        500: -511338141297693619,
        667: -8033984270955206653,
        1000: -569833905271800717,
        3333: -3101954819244458014,
        5000: 6168584438995970038,
      },
      5000: {
        100: -5469093104035258467,
        333: 288652237259539415,
        500: 3275576523629185057,
        667: 5034197303103005245,
        1000: 9179045555242983967,
        3333: -3106764344849916388,
        5000: 5714151220075127687,
      },
    },
    1000: {
      500: {
        100: 2637727839520851981,
        333: 8673241924662010793,
        500: -8121915705606559898,
        667: 3669988192852090405,
        1000: -3696154954195386819,
        3333: -5137339021437754077,
        5000: 4222241050487957533,
      },
      1000: {
        100: -5388817994560744114,
        333: -9032104380384406392,
        500: -5221327181747519499,
        667: -6433391002671576939,
        1000: 3736645602676138221,
        3333: 7035831968695894898,
        5000: 3691903223505703836,
      },
      2500: {
        100: 876516719513941151,
        333: -8392118899545316116,
        500: 3710098462900020233,
        667: 2939553281398472922,
        1000: 7321077694855887876,
        3333: -7289588115843128253,
        5000: 2685589220594044570,
      },
      5000: {
        100: 876516719513941151,
        333: 5137512613896498692,
        500: -4986760654847202683,
        667: 2311362775155174503,
        1000: -8814282282536439502,
        3333: -9033869672296333849,
        5000: -7137712823265628519,
      },
    }
  },
  Uint8List.fromList(List.generate(136, (i) => i)): {
    0: {
      500: {
        100: 2915561525985282760,
        333: 2209479159823221268,
        500: -4057324985269895126,
        667: -7233930628190313350,
        1000: -76148115975564611,
        3333: -3859331066945667302,
        5000: 1509858732865030094,
      },
      1000: {
        100: 3495862490811269988,
        333: 4613292103376563028,
        500: 4706129416755185608,
        667: 2951661439152057128,
        1000: -7072826855189515592,
        3333: -4974412740935026619,
        5000: 8953506417723693620,
      },
      2500: {
        100: -7736480419412625512,
        333: -4173717624648823985,
        500: 3818403753906368921,
        667: -610286071347829006,
        1000: 1749130001683896124,
        3333: 3504570093432320784,
        5000: 5019913416260871378,
      },
      5000: {
        100: -7736480419412625512,
        333: -6237370886884326770,
        500: -3141932166116815194,
        667: 2313554198846568625,
        1000: 7516022349342673842,
        3333: -826194923059483612,
        5000: -6338810681959681451,
      },
    },
    333: {
      500: {
        100: 4182577361579037558,
        333: -8100398321556655068,
        500: -8721289089903281097,
        667: -4525509759252978310,
        1000: -6446542254848669442,
        3333: -2593075028622937721,
        5000: 6451763259033348396,
      },
      1000: {
        100: 8184849922231961205,
        333: -3783053139057485697,
        500: 7374297528382814319,
        667: -6472464783740128551,
        1000: -8939317215393302645,
        3333: 8702261232291791077,
        5000: -1409147729818071274,
      },
      2500: {
        100: -7998697720197432595,
        333: -6015126033099317651,
        500: 2950753870710422610,
        667: -613815347575882171,
        1000: 8156716939615837565,
        3333: -610097024661989644,
        5000: 6798354353073034467,
      },
      5000: {
        100: -7998697720197432595,
        333: 3718630685587414320,
        500: -1070793489706952300,
        667: 8356676867123296286,
        1000: -5094599506490241415,
        3333: 7172393602013192028,
        5000: -8012174853096639736,
      },
    },
    667: {
      500: {
        100: -6503311515156674089,
        333: -8100398321556655068,
        500: -8721289089903281097,
        667: 5059893515433154043,
        1000: -6446542254848669442,
        3333: -2593075028622937721,
        5000: 6451763259033348396,
      },
      1000: {
        100: -1287313768612209452,
        333: -3783053139057485697,
        500: 7374297528382814319,
        667: 2388980466740494936,
        1000: -8939317215393302645,
        3333: 8702261232291791077,
        5000: -1409147729818071274,
      },
      2500: {
        100: -7998697720197432595,
        333: -6015126033099317651,
        500: 2950753870710422610,
        667: -613815347575882171,
        1000: 8156716939615837565,
        3333: -610097024661989644,
        5000: 6798354353073034467,
      },
      5000: {
        100: -7998697720197432595,
        333: 3718630685587414320,
        500: -1070793489706952300,
        667: 8356676867123296286,
        1000: -5094599506490241415,
        3333: 7172393602013192028,
        5000: -8012174853096639736,
      },
    },
    1000: {
      500: {
        100: 7905500945598857475,
        333: -8100398321556655068,
        500: -8721289089903281097,
        667: 4496562813944230525,
        1000: -6446542254848669442,
        3333: -2593075028622937721,
        5000: 6451763259033348396,
      },
      1000: {
        100: 2749704210527818752,
        333: -3783053139057485697,
        500: 7374297528382814319,
        667: 6446910861808788958,
        1000: -8939317215393302645,
        3333: 8702261232291791077,
        5000: -1409147729818071274,
      },
      2500: {
        100: -7998697720197432595,
        333: -6015126033099317651,
        500: 2950753870710422610,
        667: -613815347575882171,
        1000: 8156716939615837565,
        3333: -610097024661989644,
        5000: 6798354353073034467,
      },
      5000: {
        100: -7998697720197432595,
        333: 3718630685587414320,
        500: -1070793489706952300,
        667: 8356676867123296286,
        1000: -5094599506490241415,
        3333: 7172393602013192028,
        5000: -8012174853096639736,
      },
    }
  },
  Uint8List.fromList(List.generate(272, (i) => i)): {
    0: {
      500: {
        100: 2915561525985282760,
        333: 2209479159823221268,
        500: -4057324985269895126,
        667: -7233930628190313350,
        1000: -76148115975564611,
        3333: -3859331066945667302,
        5000: 1509858732865030094,
      },
      1000: {
        100: 3495862490811269988,
        333: 4613292103376563028,
        500: 4706129416755185608,
        667: 2951661439152057128,
        1000: -7072826855189515592,
        3333: -4974412740935026619,
        5000: 8953506417723693620,
      },
      2500: {
        100: -7736480419412625512,
        333: -4173717624648823985,
        500: 3818403753906368921,
        667: -610286071347829006,
        1000: 1749130001683896124,
        3333: 3504570093432320784,
        5000: 5019913416260871378,
      },
      5000: {
        100: -7736480419412625512,
        333: -6237370886884326770,
        500: -3141932166116815194,
        667: 2313554198846568625,
        1000: 7516022349342673842,
        3333: -826194923059483612,
        5000: -6338810681959681451,
      },
    },
    333: {
      500: {
        100: -2856790468067349638,
        333: 8391337761813603448,
        500: -1211014445602532104,
        667: -511489970786040866,
        1000: 4690178240747118185,
        3333: -8690970184010231042,
        5000: 8279429766899779634,
      },
      1000: {
        100: 7076840490811622397,
        333: 4339143609316177472,
        500: -3064324836141120856,
        667: 2097433692017706658,
        1000: 1838107294192991795,
        3333: 6420751290001006619,
        5000: -4192009164985452573,
      },
      2500: {
        100: -2804686788524375482,
        333: -8335938252797954382,
        500: -863356892854630539,
        667: 1583517529535605148,
        1000: 7241304894728253945,
        3333: 1698401441629705957,
        5000: -6363259822140094921,
      },
      5000: {
        100: -2804686788524375482,
        333: -789820962439425420,
        500: -2183078755123651517,
        667: -5348712994117430581,
        1000: 7402821711328766122,
        3333: 2358940814750830492,
        5000: -8160959048155726918,
      },
    },
    667: {
      500: {
        100: 5183154325324362203,
        333: 8391337761813603448,
        500: -1211014445602532104,
        667: 9217918549400761183,
        1000: 4690178240747118185,
        3333: -8690970184010231042,
        5000: 8279429766899779634,
      },
      1000: {
        100: -179831999961310884,
        333: 4339143609316177472,
        500: -3064324836141120856,
        667: -7344836262769101277,
        1000: 1838107294192991795,
        3333: 6420751290001006619,
        5000: -4192009164985452573,
      },
      2500: {
        100: -2804686788524375482,
        333: -8335938252797954382,
        500: -863356892854630539,
        667: 1583517529535605148,
        1000: 7241304894728253945,
        3333: 1698401441629705957,
        5000: -6363259822140094921,
      },
      5000: {
        100: -2804686788524375482,
        333: -789820962439425420,
        500: -2183078755123651517,
        667: -5348712994117430581,
        1000: 7402821711328766122,
        3333: 2358940814750830492,
        5000: -8160959048155726918,
      },
    },
    1000: {
      500: {
        100: -8078295555724101361,
        333: 8391337761813603448,
        500: -1211014445602532104,
        667: 555062345678083289,
        1000: 4690178240747118185,
        3333: -8690970184010231042,
        5000: 8279429766899779634,
      },
      1000: {
        100: 3858309602483409288,
        333: 4339143609316177472,
        500: -3064324836141120856,
        667: -2139566050273979995,
        1000: 1838107294192991795,
        3333: 6420751290001006619,
        5000: -4192009164985452573,
      },
      2500: {
        100: -2804686788524375482,
        333: -8335938252797954382,
        500: -863356892854630539,
        667: 1583517529535605148,
        1000: 7241304894728253945,
        3333: 1698401441629705957,
        5000: -6363259822140094921,
      },
      5000: {
        100: -2804686788524375482,
        333: -789820962439425420,
        500: -2183078755123651517,
        667: -5348712994117430581,
        1000: 7402821711328766122,
        3333: 2358940814750830492,
        5000: -8160959048155726918,
      },
    }
  },
};

/// The expected hashes for the smashed test files with a
/// hierarchy of keys > secret > seed > chunk-size > hash.
final multiFileValues = <List<int>, Map<Uint8List?, Map<int, Map<int, int>>>>{
  [500, 1000]: {
    null: {
      0: {
        500: 4125310302728082071,
        1000: 1861898820682605137,
        5000: -7690243511387869333,
      },
      500: {
        500: -5326035687967456636,
        1000: 4063112362287828854,
        5000: 230580466058309768,
      },
      1000: {
        500: 4899272168674007387,
        1000: -6291767464841699306,
        5000: -5967759875149067235,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: 4125310302728082071,
        1000: 1861898820682605137,
        5000: -7690243511387869333,
      },
      500: {
        500: 2341456460394804425,
        1000: -7938387351304806506,
        5000: 4501155118283550463,
      },
      1000: {
        500: 2341456460394804425,
        1000: -7938387351304806506,
        5000: 4501155118283550463,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: 4125310302728082071,
        1000: 1861898820682605137,
        5000: -7690243511387869333,
      },
      500: {
        500: -5897674244845663599,
        1000: -4055182972102346803,
        5000: -8710247060311017222,
      },
      1000: {
        500: -5897674244845663599,
        1000: -4055182972102346803,
        5000: -8710247060311017222,
      },
    },
  },
  [1000, 3333, 5000]: {
    null: {
      0: {
        500: -6437339868844382239,
        1000: -5925376956346837212,
        5000: -5645393417380393532,
      },
      500: {
        500: 1873458175770285594,
        1000: 3750266299532395745,
        5000: 3558222003216048573,
      },
      1000: {
        500: -5545586835325048994,
        1000: -1404931362494762413,
        5000: -2715947493307162498,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: -6437339868844382239,
        1000: -5925376956346837212,
        5000: -5645393417380393532,
      },
      500: {
        500: 6416982613024260123,
        1000: 1424338145416740074,
        5000: -4089689761808399224,
      },
      1000: {
        500: 6416982613024260123,
        1000: 1424338145416740074,
        5000: -4089689761808399224,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: -6437339868844382239,
        1000: -5925376956346837212,
        5000: -5645393417380393532,
      },
      500: {
        500: 2629632714100791336,
        1000: -6416018717659833793,
        5000: 2730643485029455137,
      },
      1000: {
        500: 2629632714100791336,
        1000: -6416018717659833793,
        5000: 2730643485029455137,
      },
    },
  },
  [100, 500, 1000, 5000]: {
    null: {
      0: {
        500: 6339634613784088397,
        1000: -474368899950054375,
        5000: 2334251420980925496,
      },
      500: {
        500: 8134978018249490134,
        1000: 9162451572695914894,
        5000: -5735709486327851853,
      },
      1000: {
        500: 4960477736583749873,
        1000: -6645559909289183346,
        5000: -4260326214485818669,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: 204714737054688993,
        1000: -474368899950054375,
        5000: 2334251420980925496,
      },
      500: {
        500: 4792342788709817430,
        1000: -2089723988015292025,
        5000: 5563545903260246430,
      },
      1000: {
        500: 6716136525264607633,
        1000: -2089723988015292025,
        5000: 5563545903260246430,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: 204714737054688993,
        1000: -474368899950054375,
        5000: 2334251420980925496,
      },
      500: {
        500: 2180406590005448575,
        1000: 8665210052126036205,
        5000: -8107780625230794226,
      },
      1000: {
        500: 141595982904838840,
        1000: 8665210052126036205,
        5000: -8107780625230794226,
      },
    },
  },
  [333, 500, 667, 1000, 3333]: {
    null: {
      0: {
        500: 7443310905022263392,
        1000: 2872789965868914228,
        5000: 7872785230661760093,
      },
      500: {
        500: -7828453769783710881,
        1000: -7796505713600286496,
        5000: -7030902247903336265,
      },
      1000: {
        500: 698229474784507930,
        1000: -923637589685763049,
        5000: -799469424501111091,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: 7443310905022263392,
        1000: 2872789965868914228,
        5000: 7872785230661760093,
      },
      500: {
        500: 6277540367231286817,
        1000: -3813623902163484209,
        5000: -3198211209354067551,
      },
      1000: {
        500: 6277540367231286817,
        1000: -3813623902163484209,
        5000: -3198211209354067551,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: 7443310905022263392,
        1000: 2872789965868914228,
        5000: 7872785230661760093,
      },
      500: {
        500: 3531312667899491947,
        1000: -263255180315168216,
        5000: -2644473112343738992,
      },
      1000: {
        500: 3531312667899491947,
        1000: -263255180315168216,
        5000: -2644473112343738992,
      },
    },
  },
  [100, 333, 500, 667, 1000, 3333]: {
    null: {
      0: {
        500: 5640051667469053607,
        1000: -4449649887698202412,
        5000: -2420055469951411244,
      },
      500: {
        500: 7528910179288895884,
        1000: -5291252240124417096,
        5000: 2909744047208295042,
      },
      1000: {
        500: -8016613255459610902,
        1000: -3043242030076576740,
        5000: -9100040929546435328,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: 5206989099515143421,
        1000: -4449649887698202412,
        5000: -2420055469951411244,
      },
      500: {
        500: -8031658529926984753,
        1000: 5499366164787481707,
        5000: 1633316354048453273,
      },
      1000: {
        500: 610032817249377592,
        1000: 5499366164787481707,
        5000: 1633316354048453273,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: 5206989099515143421,
        1000: -4449649887698202412,
        5000: -2420055469951411244,
      },
      500: {
        500: 2273353443812600740,
        1000: -141482529157183605,
        5000: -2395684015414704012,
      },
      1000: {
        500: -8686873678097285805,
        1000: -141482529157183605,
        5000: -2395684015414704012,
      },
    },
  },
  [100, 333, 500, 667, 1000, 3333, 5000]: {
    null: {
      0: {
        500: -6852910921849057033,
        1000: 3657122867719821862,
        5000: -6350310270388777147,
      },
      500: {
        500: -4959052146264966095,
        1000: -571986838271845983,
        5000: -6488021838638892821,
      },
      1000: {
        500: -3122743782297681553,
        1000: 176801136303630387,
        5000: -3840284187494023045,
      },
    },
    Uint8List.fromList(List.generate(136, (i) => i)): {
      0: {
        500: -308288542466848514,
        1000: 3657122867719821862,
        5000: -6350310270388777147,
      },
      500: {
        500: -7539847373700739590,
        1000: 3191000961484649260,
        5000: -5819025057768797902,
      },
      1000: {
        500: -3378220352030321669,
        1000: 3191000961484649260,
        5000: -5819025057768797902,
      },
    },
    Uint8List.fromList(List.generate(272, (i) => i)): {
      0: {
        500: -308288542466848514,
        1000: 3657122867719821862,
        5000: -6350310270388777147,
      },
      500: {
        500: -8506652326948657599,
        1000: 3049867987303944978,
        5000: -8806687815780764228,
      },
      1000: {
        500: -3480861980877473728,
        1000: 3049867987303944978,
        5000: -8806687815780764228,
      },
    },
  }
};
